image: docker:latest

variables:
  REGISTRY: 10.32.42.225:5000
  PORTAL_CONTAINER_IMAGE: ${REGISTRY}/portal:${CI_COMMIT_SHORT_SHA}
  BFF_CONTAINER_IMAGE: ${REGISTRY}/bff:${CI_COMMIT_SHORT_SHA}

build-portal:
  stage: build
  tags:
    - VRE-Deployment
  only:
    changes:
      - kubernetes/portal-deployment.yaml
      - portal/*
      - portal/*/*
      - portal/*/*/*
      - portal/*/*/*/*
      - portal/*/*/*/*/*
      - portal/*/*/*/*/*/*
      - portal/*/*/*/*/*/*/*
      - portal/*/*/*/*/*/*/*/*
      - portal/*/*/*/*/*/*/*/*/*
  script:
    - docker login ${REGISTRY} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
    - docker build --build-arg PORTAL_ENV="build-charite" --build-arg http_proxy=http://proxy.charite.de:8080/ --build-arg https_proxy=http://proxy.charite.de:8080/ -t ${PORTAL_CONTAINER_IMAGE} portal/.
    - docker push ${PORTAL_CONTAINER_IMAGE}

deploy-portal:
  stage: deploy
  tags:
    - VRE-Deployment
  only:
    changes:
      - kubernetes/portal-deployment.yaml
      - portal/*
      - portal/*/*
      - portal/*/*/*
      - portal/*/*/*/*
      - portal/*/*/*/*/*
      - portal/*/*/*/*/*/*
      - portal/*/*/*/*/*/*/*
      - portal/*/*/*/*/*/*/*/*
      - portal/*/*/*/*/*/*/*/*/*
  script:
    - sed -i "s/<VERSION>/${CI_COMMIT_SHORT_SHA}/g" kubernetes/portal-deployment.yaml
    - kubectl apply -f kubernetes/portal-deployment.yaml


build-bff:
  stage: build
  tags:
    - VRE-Deployment
  only:
    changes:
      - kubernetes/bff-deployment.yaml
      - backend/*
      - backend/*/*
      - backend/*/*/*
      - backend/*/*/*/*
      - backend/*/*/*/*/*
      - backend/*/*/*/*/*/*
      - backend/*/*/*/*/*/*/*
  script:
    - docker login ${REGISTRY} -u ${DOCKER_USER} -p ${DOCKER_PASSWORD}
    - docker build --build-arg http_proxy=http://proxy.charite.de:8080/ --build-arg https_proxy=http://proxy.charite.de:8080/ -t ${BFF_CONTAINER_IMAGE} backend/.
    - docker push ${BFF_CONTAINER_IMAGE}

deploy-bff:
  stage: deploy
  tags:
    - VRE-Deployment
  only:
    changes:
      - kubernetes/bff-deployment.yaml
      - backend/*
      - backend/*/*
      - backend/*/*/*
      - backend/*/*/*/*
      - backend/*/*/*/*/*
      - backend/*/*/*/*/*/*
      - backend/*/*/*/*/*/*/*
  script:
    - sed -i "s/<VERSION>/${CI_COMMIT_SHORT_SHA}/g" kubernetes/bff-deployment.yaml
    - kubectl apply -f kubernetes/bff-deployment.yaml
